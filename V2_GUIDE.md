# V2 챗봇 시뮬레이션 가이드

## 🎯 V2란?

V2는 연구 논문 수준의 **다층 하이브리드 모델** 기반 연애 시뮬레이션 챗봇입니다.

기존 V1과 달리:
- ✅ 4차원 감정 벡터 추적 (Valence, Arousal, Trust, Attraction)
- ✅ 관계 지표 시뮬레이션 (T신뢰, K편안함, A호감, C통합점수)
- ✅ 히스테리시스 기반 상태 머신 (친구→호감→썸→연애)
- ✅ **서윤 페르소나** - 21세 컴공과 여대생, 내성적이지만 친해지면 따뜻함
- ✅ **관계 상태별 자연스러운 말투 변화** (무뚝뚝 → 부드러움)
- ✅ LLM 2단계 호출 (분석 → 페르소나 기반 응답)
- ✅ 기억 시스템 (사용자 사실, 공유 농담, 마일스톤)
- ✅ **관심사 감지** (고양이, 애니메이션 등 언급 시 더 긍정적 반응)

## 🚀 빠른 시작

### 1. 서버 실행

```bash
pnpm dev
```

### 2. 모니터링 콘솔 열기

브라우저에서 `http://localhost:5001/v2-monitor.html` 접속

### 3. 세션 생성 및 대화 시작

1. **사용자 ID** 입력 (예: `dev_user`)
2. **"새 세션 시작"** 버튼 클릭
3. 메시지 입력 후 전송
4. 우측 패널에서 실시간 상태 모니터링

## 📊 모니터링 콘솔 기능

### 관계 상태
- 현재 관계 단계 표시 (친구/호감/썸/연애)
- 상태 지속 시간 (턴 수)
- 상태 전이 이력

### 관계 지표 (TKAC)
- **T (Trust)**: 신뢰 (0~1)
- **K (Comfort)**: 편안함 (0~1)
- **A (Affection)**: 호감 (0~1)
- **C (Relationship Score)**: 통합 관계 점수 (0~1)
- 실시간 그래프 및 추이

### 감정 벡터 (4D)
**사용자 감정 (추정)**
- Valence: 긍정-부정 (-1 ~ 1)
- Arousal: 각성-이완 (-1 ~ 1)
- Trust: 신뢰 (0 ~ 1)
- Attraction: 끌림 (0 ~ 1)

**챗봇 감정**
- 동일한 4차원 벡터
- 사용자 감정과 동조

### 턴 분석 (LLM 1차 호출 결과)
- 사용자 메시지 요약
- 감지된 감정 벡터
- 상호작용 특성:
  - 질문 깊이
  - 공감 표현
  - 자기개방 수준
  - 유머
  - 긍정성
  - 갈등 수준

### 기억 저장소
- **사용자 사실**: LLM이 자동 감지한 사용자 정보
- **공유 농담**: TODO (향후 구현)
- **마일스톤**: TODO (향후 구현)

### 디버그 로그
- API 호출 상태
- 상태 전이 이벤트
- 감정/지표 변화
- 실시간 타임스탬프

## 🔬 테스트 시나리오

### 시나리오 1: 서윤과 친해지기 (완전 초면 → 친구)
```
1. "안녕! 처음 뵙겠습니다." 
   → 서윤: "..." (눈도 안 마주침, 휴대폰만 봄)
   초기 상태: C=0.15, T=0.05, K=0.2, A=0.0
   
2. "같은 과라고 들었는데... 컴공 어때요?"
   → 서윤: "네.." (짧게 대답만, 여전히 차가움)
   C=0.18, T=0.06 (극도로 느린 변화)
   
3. "고양이 좋아해요? 저도 고양이 키워요!"
   → 서윤: "...어. 키워요." (관심사 언급으로 조금 반응)
   C=0.25, A=0.05 (관심사 감지!)
   
4. "무슨 종이에요? 저는 러시안블루인데..."
   → 서윤: "...스코티시폴드요." (조금씩 대답이 늘어남)
   C=0.30, T=0.10, K=0.25
   
5. "나중에 고양이 카페 같이 갈래요?"
   → 서윤: "글쎄요... 생각해볼게요." (아직 경계, 하지만 거절은 안 함)
   C=0.35, T=0.12
   
[여러 턴 후...]

15. "오늘 대화 즐거웠어요"
    → 서윤: "...나쁘진 않았어요." (C=0.46, 친구 단계 근접)
```

**관찰 포인트**:
- **초기 C=0.15로 매우 낮게 시작** (철벽녀)
- T (신뢰) **매우 천천히** 상승 (0.05 → 0.12)
- 관심사(고양이) 언급 시에도 조금씩만 반응
- C가 0.45 이상이 되어야 → **친구** 상태 진입
- 말투 변화: "..." → "네.." → "...어. 키워요." → "나쁘진 않았어요."
- **최소 10~15턴 이상 대화해야 친구 될 수 있음**

### 시나리오 2: 서윤의 공감 반응
```
1. "오늘 정말 힘든 일이 있었어..." (부정적)
   → 서윤: "괜찮아..? ...힘들면 말해도 돼." (조용한 위로)
   
2. "그래도 네가 있어서 다행이야" (긍정적)
   → 서윤: (작게 웃으며) "나도... 같이 있으니까 좀 나아." (감정 동조)
```

**관찰 포인트**:
- User Valence: 부정(-) → 긍정(+) 변화
- Bot Valence: 동조하여 함께 변화
- Empathy Expression 지표 상승
- 서윤의 반응: 직접적 위로보단 조용히 곁에 있어주는 스타일

### 시나리오 3: 갈등 → 회복
```
1. "왜 항상 그런 식이야?" (갈등)
2. "미안해, 내가 좀 예민했나봐" (회복)
```

**관찰 포인트**:
- Conflict 지표 급상승
- T (신뢰) 하락
- 회복 메시지 후 T 점진 상승

## 📈 관계 진행 가이드

### 상태 전이 조건

**친구 → 호감**
- C > 0.55
- T > 0.4
- K > 0.3
- 최소 2턴 유지

**호감 → 썸**
- C > 0.65
- T > 0.5
- 최소 4턴 유지

**썸 → 연애**
- C > 0.78
- T > 0.6
- K > 0.5
- 최소 7턴 유지

### 하향 전이 (히스테리시스)
- 각 임계값보다 0.07 낮은 값에서 하향 전이
- 예: 호감 → 친구는 C < 0.48 시

## 🛠️ API 사용법

### 세션 생성
```bash
curl -X POST http://localhost:5001/api/v2/chat/session \
  -H "Content-Type: application/json" \
  -d '{"userId": "test_user"}'
```

### 메시지 전송
```bash
curl -X POST http://localhost:5001/api/v2/chat/message \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "YOUR_SESSION_ID",
    "userId": "test_user",
    "message": "안녕하세요!"
  }'
```

### 상태 조회
```bash
curl http://localhost:5001/api/v2/chat/status/YOUR_SESSION_ID
```

## 🔧 파라미터 조정

상세한 파라미터는 다음 파일에서 조정 가능:

- `src/services/v2/emotionState.ts`: 감정 업데이트 파라미터
- `src/services/v2/relationshipState.ts`: 관계 지표 및 상태 전이 임계값
- `src/services/v2/policy.ts`: 응답 정책 프리셋

## ⚠️ 알려진 제약사항

현재 간소화된 구현:
- ❌ 유사도(S) 계산 미구현 (기본값 0.5)
- ❌ 일관성/약속이행 추적 미구현
- ❌ 공유 농담/마일스톤 자동 감지 미구현
- ❌ 챗봇 자기개방 수준 동적 계산 미구현
- ❌ 갈등 누적 하향 전이 미구현

✅ **구현 완료**:
- ✅ 서윤 페르소나 통합 (성격, 배경, 관심사)
- ✅ 관계 상태별 말투 자동 변화
- ✅ 관심사 키워드 감지 (고양이, 애니, 컴공 등)
- ✅ 감정/관계 상태 기반 응답 조정
- ✅ 미세 표현 ("...", 행동 묘사)

→ 자세한 내용은 `src/services/v2/README.md` 참조

## 📚 추가 리소스

- [V2 아키텍처 상세](src/services/v2/README.md)
- [타입 정의](src/services/v2/types.ts)
- [수학적 모델](src/services/v2/emotionState.ts) - 주석 참조

---

**Tip**: 모니터링 콘솔을 열어두고 대화하면 내부 동작을 실시간으로 확인할 수 있습니다!

