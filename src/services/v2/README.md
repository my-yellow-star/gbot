# V2 챗봇 시뮬레이션

다층 하이브리드 모델 기반 연애 시뮬레이션 챗봇의 간소화된 구현입니다.

## 🏗️ 아키텍처

### 전반 구조
- **연속 감정 상태**: 챗봇과 사용자의 정서·애착을 4차원 벡터로 추적
- **관계 점수**: 신뢰(T), 편안함(K), 호감(A)을 통합한 관계 점수(C)
- **상태 머신**: 친구 → 호감 → 썸 → 연애 (히스테리시스 기반 전이)
- **응답 정책**: 현재 감정·관계·상태에 맞춘 응답 스타일 자동 조정

### LLM 2단계 호출 구조
1. **1차 호출**: 사용자 발화 분석 (감정, 특성, 내용 이해)
2. **2차 호출**: 정책 기반 최종 응답 생성 (말투, 스타일)

## 📁 파일 구조

```
v2/
├── types.ts              # 타입 정의
├── emotionState.ts       # 감정 상태 관리
├── relationshipState.ts  # 관계 점수 및 상태 머신
├── policy.ts            # 응답 정책 생성
├── persona.ts           # 서윤 페르소나 (NEW!)
├── llm.ts               # LLM 2단계 호출
├── chatbot.ts           # 메인 챗봇 로직 (턴 업데이트)
└── index.ts             # 엔트리 포인트
```

## 🔬 핵심 수식 구현

### 1. 사용자 감정 추정 (지연·관성)
```
e_u_hat(t) = (1-λu) * e_u_hat(t-1) + λu * e_u_tilde(t)
```
- `λu = 0.5`: 관성 계수

### 2. 챗봇 감정 동역학
```
e_c(t+1) = (1-α)*e_c(t) + β*(e_u - e_c) + Γ*g(I,f,M) + ξ
```
- `α = 0.1`: 감정 감쇠율
- `β = 0.4`: 동조 민감도
- `Γ`: 상호작용 증폭 행렬
- `ξ`: 미세 잡음 (인간미)

### 3. 관계 지표 업데이트
```
T(t+1) = (1-η_T)*T(t) + η_T*[φ1·일관성 + φ2·약속이행 + φ3·공감]
K(t+1) = (1-η_K)*K(t) + η_K*[ψ1·편안감 - ψ2·압박감]
A(t+1) = (1-η_A)*A(t) + η_A*[ρ1·긍정 + ρ2·신선함 - ρ3·충돌]
```

### 4. 통합 관계 점수
```
C(t+1) = (1-ζ)*C(t) + ζ*[w1*Align + w2*T + w3*A + w4*K + w5*S + w6*SD_bal] - χ*penalty
```
- 정서 정렬, 신뢰, 호감, 편안함, 유사도, 자기개방 균형 종합
- 속도 패널티: 너무 빠른 관계 진전 방지

### 5. 상태 전이 (히스테리시스)
```
친구 → 호감:   C > 0.55, T > 0.4, K > 0.3 (2턴 이상)
호감 → 썸:     C > 0.65, T > 0.5 (4턴 이상)
썸 → 연애:     C > 0.78, T > 0.6, K > 0.5 (7턴 이상)
```
- 하향 전이 임계값은 0.07 낮게 설정 (히스테리시스)

## 🎯 사용법

### API 엔드포인트

#### 1. 세션 생성
```bash
POST /api/v2/chat/session
{
  "userId": "user123"
}
```

#### 2. 메시지 전송
```bash
POST /api/v2/chat/message
{
  "sessionId": "...",
  "userId": "user123",
  "message": "안녕! 오늘 기분 어때?"
}
```

응답:
```json
{
  "sessionId": "...",
  "response": "안녕! 나는 괜찮아~ 너는 어때? 😊",
  "state": "friend",
  "metrics": {
    "C": 0.42,
    "T": 0.35,
    "K": 0.55,
    "A": 0.28
  },
  "emotion": {
    "user": "긍정/보통 (신뢰:50%, 끌림:30%)",
    "bot": "긍정/보통 (신뢰:40%, 끌림:25%)"
  }
}
```

#### 3. 대화 내역 조회
```bash
GET /api/v2/chat/history/:sessionId
```

#### 4. 상태 조회
```bash
GET /api/v2/chat/status/:sessionId
```

## 🔧 파라미터 튜닝

### `emotionState.ts`
- `alpha`: 감정 감쇠율 (기본: 0.1)
- `beta`: 동조 민감도 (기본: 0.4)
- `lambdaU`: 사용자 감정 관성 (기본: 0.5)
- `gamma`: 상호작용 증폭 (valence: 0.2, arousal: 0.15, trust: 0.25, attraction: 0.3)

### `relationshipState.ts`
- `etaT`, `etaK`, `etaA`: 관계 지표 업데이트율
- `zeta`: 통합 관계 점수 업데이트율 (기본: 0.3)
- `weights`: 통합 점수 가중치 (w1~w6)
- `thresholds`: 상태 전이 임계값
- `minDuration`: 상태별 최소 지속 시간

### `policy.ts`
- 관계 상태별 정책 프리셋
- 감정·관계 상태에 따른 동적 조정

## ⚠️ 현재 제약사항 및 TODO

### 구현 완료
- ✅ 4차원 감정 벡터 추적
- ✅ 관계 점수 통합 업데이트
- ✅ 히스테리시스 기반 상태 머신
- ✅ 정책 기반 응답 생성
- ✅ LLM 2단계 호출
- ✅ 기억(사용자 사실) 저장

### 구현 완료 ✅
- ✅ **서윤 페르소나**: 21세 컴공과 여대생 캐릭터, 내성적이지만 친해지면 따뜻함
- ✅ **관계 상태별 자연스러운 말투**: C값에 따라 "네.." → "나쁘지 않아.." 등으로 변화
- ✅ **관심사 감지**: 고양이, 애니메이션 등 키워드 감지 시 긍정 반응 증가
- ✅ **감정 기반 응답**: 사용자 감정(슬픔, 기쁨)에 따라 서윤답게 반응
- ✅ **미세 표현**: "...", 행동 묘사 (작게 웃으며), 시선 회피 등

### 간소화/보완 필요 ⚠️
- ⚠️ **일관성, 약속이행 추적**: 현재는 공감·긍정성으로 대체
- ⚠️ **유사도(S) 계산**: 취향·가치 매칭 미구현 (기본값 0.5)
- ⚠️ **챗봇 자기개방 수준**: 고정값 사용 중 (응답 분석 필요)
- ⚠️ **기억 회상 점수**: 단순 개수로 계산 (품질 미반영)
- ⚠️ **공유 농담, 마일스톤**: 자동 감지 미구현
- ⚠️ **갈등 누적**: 하향 전이에 반영 안 됨

### 추후 추가 예정 (명세 10, 11번)
- ❌ 학습·튜닝: 로그 수집 및 강화학습
- ❌ 안전·윤리: 조작 방지, 거부 신호 자동 조정

## 📊 상태 모니터링

### 디버깅 로그
```typescript
logger.debug() // 턴별 감정 분석, 응답 생성
logger.info()  // 상태 전이, 세션 생성
```

### 주요 지표
- **C**: 통합 관계 점수 (0~1)
- **T**: 신뢰 (0~1)
- **K**: 편안함 (0~1)
- **A**: 호감 (0~1)
- **state**: friend | interest | flirting | dating
- **stateDuration**: 현재 상태 지속 시간 (턴 수)

## 🚀 개선 방향

1. **실제 대화 로그 수집**: 사용자 피드백 기반 파라미터 튜닝
2. **유사도 계산**: 사용자 프로필 기반 취향·가치 매칭
3. **고급 기억 시스템**: 중요도 점수, 시간 감쇠, 연관성 그래프
4. **갈등 복구 메커니즘**: 사과·재구성 패턴 인식
5. **다양한 페르소나**: 다른 성격의 챗봇 추가
6. **음성 인터페이스**: 프로소디 분석 → arousal 추정
7. **장기 관계 모델링**: 주·월 단위 이벤트, 기념일

## 📝 라이선스

MIT

---

**Note**: 이 구현은 제공된 수학적 모델의 간소화 버전입니다. 
실전 배포 시에는 파라미터 튜닝, 안전 가드레일, 사용자 피드백 루프가 필수적입니다.

